/*! dhx 2015-05-26 */
$dhx.ui.crud.simple.View={layout:null,menu:[],ribbon:[],tab:null,grid:null,status_bar:null,task_bar:null,task_bar:null,window:[],openedCRUD:[],strWindowID:"$dhx.ui.crud.simple.View.generic.window.",status_bar:function(a,b){this.template="<div id='status_info'>Initializing "+$dhx.ui.controller[a].appName+"</div><div id='expiration_info' title='time remaining for token expiration' class='expiration_info'></div><div id='user_info'><img id='user_info_status' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABvUlEQVR4XpWRy0tbQRjFz9yH3hgtruzGRqRx47aoaxvBdboo7qTtrst2WRAfDcZo/wAR/BPiRroouHHZFqmCT9DEV0uiYmjD9OZO5k5nRiPk0Rvyg8vhG74535nvEtSQTC6mXdeNozlwHGetzmB6es6fmvpAJAhCCIHZ2QQs1KMvPx5+jSByX1e1klYi/2E2ds5K2D7IaoOZmY93kSWiGapH9oqB0beiZ+iVkOjaajUyZVW7qd7BYLQXBiEwTAMED406cgU71AlWoo0N/roeTNOEadnwhY9C4Tc8z6uaSAv5/yfwfFNOd+QlIs0YyrwNjLGGT5E7UW8XVQa3lKM9bMF2OuG0AcwtAoTgHbaQjfVhEpC6ggqxnqdZqyae/mp50XWJJ2vbIB1hnI1HEVnfQzn3E3gz1q/+pc85F0FknkcEZ54u2HVOK6dFfU5SqU9pSmkcAUxu6tg6hfmoG+WbPC5eDkEzv5B4f3xyxL9sfBaHR/tC6daPb/f6XamapCcqWP6XVl5y9blFCJZOMscIOSGcnmdgWTaub65gGIbUPGxZKwRj8M0SLiZGHnagIMlUQqAJz3Y3ET3fRwOW/wEKrjnBHaxMrAAAAABJRU5ErkJggg==' /> <span>Not authorized yet</span></div><div id='data_transfer_info'> no data transferred</div><div id='socket_info' class='data_transfer_info'>socket: disconnected</div><div id='errors_info'>no errors</div>",this._setStatus=function(a){document.getElementById("status_info").innerHTML=a},this._setStatusError=function(a){document.getElementById("errors_info").innerHTML=a},this._setStatusDataTransfer=function(a,c){c?(document.getElementById("data_transfer_info").innerHTML=a,document.getElementById("data_transfer_info").style.backgroundImage="url("+b+"network.gif)"):(document.getElementById("data_transfer_info").innerHTML=a,document.getElementById("data_transfer_info").style.backgroundImage="url("+b+"network-accept.png)")},this._setStatusSocket=function(a,c){dhtmlx.message({text:a}),document.getElementById("socket_info").innerHTML="socket: "+a,document.getElementById("socket_info").style.backgroundImage="url("+b+"socket.gif)",c&&(document.getElementById("socket_info").style.backgroundImage="url("+b+"socket_disconnected.png)")},this._setStatusUser=function(a,c){"undefined"==typeof c&&(c=!0),document.getElementById("user_info").getElementsByTagName("span")[0].innerHTML=a,c?document.getElementById("user_info_status").src=""+b+"online.png":(document.getElementById("user_info_status").src=""+b+"offline.png",dhtmlx.message({type:"error",text:a}))}},helpers:{disableButtonActions:function(a){var b=$dhx.ui.controller[a].view;b.menu[a].setItemDisabled("update"),b.menu[a].setItemDisabled("open"),b.ribbon[a]&&(b.ribbon[a].disable("delete"),b.ribbon[a].disable("update"),b.ribbon[a].disable("previous"),b.ribbon[a].disable("next"),b.ribbon[a].disable("open"))},enableButtonActions:function(a){var b=$dhx.ui.controller[a].view;b.menu[a].setItemEnabled("update"),b.menu[a].setItemEnabled("open"),b.ribbon[a]&&(b.ribbon[a].enable("delete"),b.ribbon[a].enable("update"),b.ribbon[a].enable("previous"),b.ribbon[a].enable("next"),b.ribbon[a].enable("open"))},viewRecord:function(a,b){var c=$dhx.ui.controller[b].view,d=b.split("crud.simple.")[1];d=d.split("_")[0];var e=$dhx.ui.data.model.db.juris.schema[d],f={wrapper:c.tab,record_id:a,table:d,db:$dhx.ui.controller[b].database};c.ribbon[b]||(f.is_generic=!0),$dhx.ui.crud.simple.View.Record.render(f,e)}},destroy:function(a,b,c){try{var d=$dhx.ui.controller[a].view;$dhx.showDirections("starting view ... "),d.grid.destructor();var e=a.split("crud.simple.")[1];e=e.split("_")[0],b=$dhx.ui.data.model.db.juris.schema[e],b.unsync.grid({component:d.grid,component_id:"main_grid_"+a,onSuccess:function(){},onFail:function(){c._setStatusError("could not unsync grid")}}),$dhx.hideDirections()}catch(f){console.log(f.stack)}},_window:function(a,b,c,d){console.log($dhx.ui.controller);var e=$dhx.ui.controller[b].view;return e.window[a]=$dhx.ui.window_manager.createWindow({id:e.strWindowID+b,left:$dhx.ui.crud.simple.View.settings.app_generic.window.left,top:$dhx.ui.crud.simple.View.settings.app_generic.window.top,width:$dhx.ui.crud.simple.View.settings.app_generic.window.width,height:$dhx.ui.crud.simple.View.settings.app_generic.window.height}),e.window[a].attachEvent("onClose",function(a){d&&d(),a.hide()}),e.window[a].setText(""),e.window[a].attachStatusBar(),e.window[a]},_layout:function(a){var b=$dhx.ui.controller[a].view;console.log($dhx.ui.controller[a]),$dhx.ui.controller[a].configuration.wrapper===document.body?b.layout=new dhtmlXLayoutObject($dhx.ui.crud.simple.View.settings.layout):b.layout=$dhx.ui.controller[a].configuration.wrapper.attachLayout($dhx.ui.crud.simple.View.settings.layout),b.layout.cells("a").hideHeader(),b.task_bar=b.layout.attachStatusBar()},_menu:function(a,b,c,d){var e=$dhx.ui.controller[a].view;e.menu[a]=e.layout.cells("a").attachMenu($dhx.ui.crud.simple.View.settings.menu),e.menu[a].attachEvent("onClick",function(f){if("print"==f);else if("insert"==f)$dhx.ui.crud.simple.View.FormWindow.render({database:$dhx.ui.controller[a].database,table:$dhx.ui.controller[a].collection,schema:d});else if("update"==f)e.grid.getSelectedRowId()&&$dhx.ui.crud.simple.View.FormWindow.render({record_id:e.grid.getSelectedRowId(),database:$dhx.ui.controller[a].database,table:$dhx.ui.controller[a].collection,schema:d});else if("open"==f)e.grid.getSelectedRowId()&&e.helpers.viewRecord(e.grid.getSelectedRowId(),a,d);else if(f.indexOf("table.")>-1){f.split(".")[1];console.log(c);for(var g in c){console.log(c);var h=g+"."+c[g].table,i=e._window(h,a,d,function(){$dhx.ui.controller["$dhx.ui.crud.simple."+c[g].table+"_app"].view.destroy("$dhx.ui.crud.simple."+c[g].table+"_app",d,b)});e.openedCRUD[h]=new $dhx.ui.crud.simple({wrapper:i,database:$dhx.ui.controller[a].database,collection:c[g].table,base_path:$dhx.ui.crud.simple.View.settings.base_path})}}})},_tab:function(a,b){var c=$dhx.ui.controller[a].view;c.tab=c.layout.cells("a").attachTabbar($dhx.ui.crud.simple.View.settings.tab),$dhx.ui.controller[a].configuration.wrapper===document.body&&(c.status_bar=c.tab.cells("records").attachStatusBar(),c.status_bar.setText(b.template)),c.tab.attachEvent("onTabClose",function(a){try{}catch(b){}return!0})},_grid:function(a,b,c){var d=$dhx.ui.controller[a].view;d.grid=d.tab.cells("records").attachGrid(),d.grid.saveOnEdit=!0,c.sync.grid({component:d.grid,component_id:"main_grid_"+a,auto_configure:!0,onSuccess:function(){},onFail:function(){b._setStatusError("could not syn grid")}})},_ribbon:function(a,b,c){var d=$dhx.ui.controller[a].view;d.ribbon[a]=d.layout.cells("a").attachRibbon($dhx.ui.crud.simple.View.settings.ribbon),d.helpers.disableButtonActions(a),d.ribbon[a].attachEvent("onClick",function(e){"select"==e?c.load(function(a,b,c,e){d.helpers.disableButtonActions(controller)},function(a,b,c){console.log(c)}):"gettotal"==e?(b._setStatusDataTransfer("counting records",!0),c.count(function(a,c,d){b._setStatusDataTransfer("total records: "+d,!1)},function(a,c,d){b._setStatusError(d)})):"getquota"==e?(b._setStatusDataTransfer("getting quota information",!0),that.model.db._getQuota(function(a,c){a=a/1024/1024/1024,c=c/1024/1024/1024;var d="used: "+a.toFixed(5)+"GB. remaining: "+c.toFixed(2)+"GB";$dhx.notify("Quota information",d,"icons/db.png"),b._setStatusDataTransfer("used: "+a.toFixed(5)+"GB. remaining: "+c.toFixed(2)+"GB",!1)},function(a){b._setStatusDataTransfer(a,!1)})):"first"==e?(b._setStatusDataTransfer("requesting first record",!0),c.first(function(a,c,d,e){b._setStatusDataTransfer("id: "+a,!1)},function(a,c,d){b._setStatusError(d)})):"next"==e?(b._setStatusDataTransfer("requesting next record",!0),c.next(function(a,c,d,e){b._setStatusDataTransfer("id: "+a,!1)},function(a,c,d){b._setStatusError(d),$dhx.notify("navigation",d,"icons/db.png")})):"previous"==e?(b._setStatusDataTransfer("requesting previous record",!0),c.previous(function(a,c,d,e){b._setStatusDataTransfer("id: "+a,!1)},function(a,c,d){b._setStatusError(d),$dhx.notify("navigation",d,"icons/db.png")})):"last"==e?(b._setStatusDataTransfer("requesting last record",!0),c.last(function(a,c,d,e){b._setStatusDataTransfer("id: "+a,!1)},function(a,c,d){b._setStatusError(d)})):"gettablesize"==e?(b._setStatusDataTransfer("requesting table size",!0),c.getTableSizeInBytes(function(a,c,d){var d=(d/1024).toFixed(2)+" KB";b._setStatusDataTransfer("table size :"+d,!1)},function(a,c,d){b._setStatusError(d)})):"cleartable"==e?(b._setStatusDataTransfer("deleting all records",!0),c.clearAll(function(a,c){b._setStatusDataTransfer("all records deleted",!1)},function(a,c,d){b._setStatusError(d)})):"insert"==e?$dhx.ui.crud.simple.View.FormWindow.render({database:$dhx.ui.controller[a].database,table:$dhx.ui.controller[a].collection,schema:c}):"update"==e?d.grid.getSelectedRowId()&&$dhx.ui.crud.simple.View.FormWindow.render({record_id:d.grid.getSelectedRowId(),database:$dhx.ui.controller[a].database,table:$dhx.ui.controller[a].collection,schema:c}):"open"==e?d.grid.getSelectedRowId()&&d.helpers.viewRecord(d.grid.getSelectedRowId(),a,c):"find"==e?d.Search.render():"getCursor"==e?(b._setStatusDataTransfer("getting cursor",!0),c.getCursor(function(a,c,d){b._setStatusDataTransfer("cursor got "+a,!1)},function(a,c,d){b._setStatusError(d)})):"delete"==e?d.grid.getSelectedRowId()&&(b._setStatusDataTransfer("deleting record",!0),c.del(d.grid.getSelectedRowId(),function(a,c,e){b._setStatusDataTransfer("record deleted: "+e,!1),d.helpers.disableButtonActions(controller)},function(a,c,d){b._setStatusError(d)})):"dropdb"==e&&(b._setStatusDataTransfer("deleting database",!0),that.model.db.drop(function(a,c,d){b._setStatusDataTransfer(a,!1)},function(a,c,d){b._setStatusError(d)}))})},controller:[],render:function(a){var b=a.appId;console.log("XXXXXXXXXXXXXMMMMMMXXXXXMMMMXXX",a);var c=$dhx.ui.controller[b],d=$dhx.ui.data.model.db[a.database].schema[a.collection],e=($dhx.ui.data.model.settings[a.database][a.collection],$dhx.ui.data.model.schema[a.database][a.collection].foreign_keys);c=$dhx.ui.controller[b].view,$dhx.showDirections("starting view ... "),c._layout(b);var f=new c.status_bar(b,$dhx.ui.crud.simple.View.settings.icons_path);c._tab(b,f),c._grid(b,f,d),c._menu(b,f,e,d),c.tab.tabs("records").setText($dhx.ui.controller[b].collection.toUpperCase()),$dhx.ui.controller[b].configuration.wrapper===document.body&&c._ribbon(b,f,d);var g=0,h=!1;for(var i in e)h||c.menu[b].addNewSibling("edit","fkeys_table","Related tables",!1),h=!0,c.menu[b].addNewChild("fkeys_table",g,"table."+e[i].table,"edit "+e[i].table+" table",!1,"form.gif"),g+=1;d.attachEvent("onAfterCursorChange",function(c,e){e==a.collection&&(console.log(b),console.log(d),$dhx.ui.controller[b].view.helpers.enableButtonActions(b),f._setStatusDataTransfer("selected: "+c,!1))}),d.attachEvent("onBeforeCursorChange",function(a){}),d.attachEvent("onAfterAdd",function(a,c){$dhx.ui.controller[b].view.helpers.enableButtonActions(b),f._setStatusDataTransfer("added: "+c+" records",!1)}),d.attachEvent("onBeforeAdd",function(){}),f._setStatusDataTransfer("counting records",!0),d.count(function(a,b,c){f._setStatusDataTransfer("got total records",!1),f._setStatus("total records: "+c)},function(a,b,c){f.setText("error when counting records: "+c)}),window.addEventListener("popstate",function(a){console.log("popstate fired!"),console.log(a),console.log(a.state)}),history.pushState("start","start","#start"),$dhx.hideDirections()}};